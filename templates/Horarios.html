<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  </head>
<body>
  <nav class="navbar sticky-top" style="background-color:#EC3237 ;color: #ffffff;padding: 0.5rem 1rem; height: 3rem;">  
    <div class="d-flex justify-content-around" style="background-color:#EC3237">
      <div class="p-2"> <a href="/home" style="text-decoration: none; color: #ffffff;">Página Principal</a></div>
      <div class="p-2"> <a href="/comunidades/" style="text-decoration: none; color: #ffffff;">Comunidades</a></div>
    </div>
  </nav>
  <nav class="navbar" style="background-color:#424242 ;color: #ffffff;">  
    <div class="d-flex justify-content-around">
      <img src="https://i.ibb.co/2MkzN5x/logo-ULEAM-2017-horizontal-blanco.png" style="height: 4rem;">
    </div>
  </nav>
  <div class="row align-self-center">
    <div class="col-4"></div>
    <div class="col-4 d-flex justify-content-center align-items-center">
      <label for="" style="color: #EC3237;" class="fs-2 fw-semibold">Área de trabajo</label>
    </div>
    <div class="col-4"></div>
  </div>
  <div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12">
      <div class="container">
        <div class="container" style="border: 1px solid rgba(0, 0, 0, 0.2)">
          <div class="row bg-light p-2" style="border: 1px solid rgba(0, 0, 0, 0.2); border-top: none; border-right: none; border-left: none;">
            <label style="color: #EC3237;" class="fs-6 fw-light">Agregar Horario</label>
          </div>
          <form id="horarioForm" class="p-2">
            <div class="col-md-6">
              <label for="file" class="form-label fs-6" style="color: #3d1214">Subir archivo PDF:</label>
              <input type="file" id="file" class="form-control" name="file" required>
              <div id="archivo_pdf_help" class="form-text">
                  Por favor, selecciona un archivo PDF para subir.
              </div>
            </div>
            
            <label for="periodo_horario" class="form-label fs-6" style="color: #3d1214">Periodo del horario:</label><br>
            <input type="text" id="periodo_horario" class="form-control" name="periodo_horario" aria-describedby="passwordHelpBlock">
            <div id="periodo_horario" class="form-text">
              Aquí agrega el periodo del horario
            </div>
            <label for="observacion" class="form-label">Observaciones:</label><br>
            <textarea id="observacion" name="observacion" class="form-control"></textarea>
            <div id="observacion" class="form-text">
                        Aquí simplemente algún dato extra, no es obligatorio ...
            </div>
            
            <div id="statusMessage" class="mt-2 bg-danger "style="color: #3d1214"></div>

            <div class="row">
              <div class="col-10"></div>
              <div class="col-2">
                <button type="submit" class="btn btn-outline-primary">Añadir</button>
              </div>
            </div>
          </form>
        </div>                
      </div>                
    </div>
    <div class="p-2"></div>
    <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12">
      <div class="container">
        <div class="container" style="border: 1px solid rgba(0, 0, 0, 0.2)">
          <div class="row bg-light p-2" style="border: 1px solid rgba(0, 0, 0, 0.2); border-top: none; border-right: none; border-left: none;">
            <label style="color: #EC3237;" class="fs-6 fw-light">Horarios</label>
          </div>
          <table class="table table-striped" id="tablaHorarios">
            <thead>
              <tr>
                <th>#</th>
                <th>Períodos</th>
                <th>Observaciones</th>
                <th>Almacenada</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <!-- Filas de la tabla se añadirán aquí -->
            </tbody>
          </table>
        </div>                
      </div>
      <div class="p-4"></div>
    </div>
    <div class="p-2"></div>
    <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12">
      <div class="container">
        <div class="container" style="border: 1px solid rgba(0, 0, 0, 0.2)">
          <div class="row bg-light p-2" style="border: 1px solid rgba(0, 0, 0, 0.2); border-top: none; border-right: none; border-left: none;">
            <label style="color: #EC3237;" class="fs-6 fw-light">Horarios individuales</label>
          </div>
          <table class="table table-striped" id="horarios_individual">
            <thead>
              <tr>
                <th>#</th>
                <th>Nombres en Drive</th>
                <th>ID drive</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <!-- Filas de la tabla se añadirán aquí -->
            </tbody>
          </table>
        </div>                
      </div>
      <div class="p-4"></div>
    </div>
  </div>
</body>
<script>
  document.getElementById("horarioForm").addEventListener("submit", function(event) {
      // Mostrar mensaje de espera al usuario
      var statusMessage = document.getElementById("statusMessage");
      statusMessage.innerHTML = 'Procesando... Esto puede tardar un momento. Espere por favor.';
  });

  // Variable global para almacenar el ID de OneDrive
  let id_onedrive = null;
  
  // Manejar el envío del formulario
  document.getElementById("horarioForm").addEventListener("submit", function(event) {
      event.preventDefault(); // Evitar envío tradicional del formulario

      var formData = new FormData(this); // Obtener datos del formulario

      // Agregar el ID de OneDrive a la FormData si está disponible
      if (id_onedrive) {
          formData.append('id_onedrive', id_onedrive);
      }

      // Realizar la solicitud al servidor
      fetch("/upload_and_add_horario", {
          method: "POST",
          body: formData
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Error al agregar horario');
          }
          return response.text(); // Obtener el mensaje de éxito en texto
      })
      .then(message => {
          alert(message); // Mostrar mensaje al usuario (puedes cambiar esto por un modal o actualizar la interfaz según necesites)
        cargarHorarios()
        cargarHorarios_Individuales()
        })
      .catch(error => {
          console.error('Error:', error);
      });
    
  });
  function cargarHorarios() {
          fetch('/api/horarios')
              .then(response => response.json())
              .then(data => {
                  // Obtener la lista de comunidades del objeto JSON recibido
                  const horarios = data.horarios;

                  // Seleccionar el cuerpo de la tabla donde se mostrarán las comunidades
                  const tablaHorarios = document.querySelector('#tablaHorarios tbody');
                  tablaHorarios.innerHTML = ''; // Limpiar la tabla existente
                  let contador = 1;
                  let subida = "si"

                  // Iterar sobre cada comunidad y crear una fila para mostrarla en la tabla
                  horarios.forEach(horario=> {
                      const tr = document.createElement('tr');
                      tr.innerHTML = `
                          <td>${contador}</td>
                          <td>${horario.periodo_horario}</td>
                          <td>${horario.observacion}</td>
                          <td>${subida}</td>
                          <td>${horario.title}</td>


                          <td>
                              <button class="btn btn-danger btn-sm" onclick="eliminarHorario('${horario._id}')">Eliminar</button>
                          </td>
                      `;
                      contador++;
                      tablaHorarios.appendChild(tr);
                  });
              })
              .catch(error => {
                  console.error('Error:', error);
                  alert('Ocurrió un error al obtener la lista de horarios.');
              });
      }
      document.addEventListener('DOMContentLoaded', function() {
      cargarHorarios();
      cargarHorarios_Individuales();
});
function eliminarHorario(id) {
    fetch("/eliminar/horario/" + encodeURIComponent(id), {
        method: "DELETE"
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert(data.mensaje);
            cargarHorarios(); // Recargar la lista de formatos
            cargarHorarios_Individuales();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("Ocurrió un error al eliminar el Horario");
    });

}
function cargarHorarios_Individuales() {
          fetch('/api/horarios_individual')
              .then(response => response.json())
              .then(data => {
                  // Obtener la lista de comunidades del objeto JSON recibido
                  const horarios_i = data.horarios_individuales;

                  // Seleccionar el cuerpo de la tabla donde se mostrarán las comunidades
                  const tablaHorarios_i = document.querySelector('#horarios_individual tbody');
                  tablaHorarios_i.innerHTML = ''; // Limpiar la tabla existente
                  let contador = 1;

                  // Iterar sobre cada comunidad y crear una fila para mostrarla en la tabla
                  horarios_i.forEach(horario=> {
                      const tr = document.createElement('tr');
                      tr.innerHTML = `
                          <td>${contador}</td>
                          <td>${horario.horario_nombre_imagen}</td>
                          <td>${horario.imagen_ids}</td>
                          <td>${horario.title}</td>

                          <td>
                            <button class="btn btn-info btn-sm" onclick="ver('${horario.imagen_ids}')">Ver</button>
                          </td>
                      `;
                      contador++;
                      tablaHorarios_i.appendChild(tr);
                  });
              })
              .catch(error => {
                  console.error('Error:', error);
                  alert('Ocurrió un error al obtener la lista de horarios.');
              });
      }
      document.addEventListener('DOMContentLoaded', function() {
      cargarHorarios_Individuales();
      cargarHorarios();
});
 // Función JavaScript para construir y abrir el enlace a Google Drive
 function ver(id) {
      var url = `https://drive.google.com/file/d/${id}/view`;
      window.open(url, '_blank'); // Abrir enlace en una nueva pestaña
}


</script>
